generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid()) @db.VarChar(255)
  phone         String         @unique @db.VarChar(20)
  password      String         @db.VarChar(255)
  name          String         @db.VarChar(255)
  email         String?        @db.VarChar(255)
  role          UserRole       @default(CUSTOMER)
  fcmToken      String?        @map("fcm_token")
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  addresses     Address[]
  notifications Notification[]
  orders        Order[]

  @@map("users")
}

model Address {
  id           String    @id @default(uuid()) @db.VarChar(255)
  userId       String    @map("user_id") @db.VarChar(255)
  label        String    @db.VarChar(100)
  street       String
  city         String    @db.VarChar(100)
  state        String    @db.VarChar(100)
  zipCode      String    @map("zip_code") @db.VarChar(20)
  latitude     Float?
  longitude    Float?
  isDefault    Boolean   @default(false) @map("is_default")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  last_used_at DateTime? @db.Timestamp(6)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_address_user")
  orders       Order[]

  @@index([userId], map: "idx_addresses_user_id")
  @@map("addresses")
}

model Product {
  id          String      @id @default(uuid()) @db.VarChar(255)
  name        String      @db.VarChar(255)
  description String
  imageUrl    String      @map("image_url")
  price       Decimal     @db.Decimal(10, 2)
  category    String      @db.VarChar(100)
  unit        String      @db.VarChar(50)
  available   Boolean     @default(true)
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  orderItems  OrderItem[]

  @@map("products")
}

model Order {
  id                    String         @id @default(uuid()) @db.VarChar(255)
  orderNumber           String         @unique @map("order_number") @db.VarChar(50)
  customerId            String         @map("customer_id") @db.VarChar(255)
  addressId             String         @map("address_id") @db.VarChar(255)
  status                OrderStatus    @default(PLACED)
  subtotal              Decimal        @db.Decimal(10, 2)
  deliveryFee           Decimal        @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  tax                   Decimal        @default(0) @db.Decimal(10, 2)
  total                 Decimal        @db.Decimal(10, 2)
  paymentMethod         PaymentMethod  @map("payment_method")
  paymentStatus         PaymentStatus  @default(PENDING) @map("payment_status")
  notes                 String?
  estimatedDeliveryTime DateTime?      @map("estimated_delivery_time") @db.Timestamp(6)
  deliveredAt           DateTime?      @map("delivered_at") @db.Timestamp(6)
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  notifications         Notification[]
  items                 OrderItem[]
  address               Address        @relation(fields: [addressId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_address")
  customer              User           @relation(fields: [customerId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_customer")

  @@index([customerId], map: "idx_orders_customer_id")
  @@index([status], map: "idx_orders_status")
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid()) @db.VarChar(255)
  orderId   String  @map("order_id") @db.VarChar(255)
  productId String  @map("product_id") @db.VarChar(255)
  quantity  Int
  unitPrice Decimal @map("unit_price") @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_order_item_order")
  product   Product @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_order_item_product")

  @@index([orderId], map: "idx_order_items_order_id")
  @@index([productId], map: "idx_order_items_product_id")
  @@map("order_items")
}

model Notification {
  id        String           @id @default(uuid()) @db.VarChar(255)
  userId    String           @map("user_id") @db.VarChar(255)
  orderId   String?          @map("order_id") @db.VarChar(255)
  title     String           @db.VarChar(255)
  body      String
  type      NotificationType @default(ORDER_STATUS)
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  order     Order?           @relation(fields: [orderId], references: [id], onUpdate: NoAction, map: "fk_notification_order")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_notification_user")

  @@index([orderId], map: "idx_notifications_order_id")
  @@index([userId], map: "idx_notifications_user_id")
  @@map("notifications")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum OrderStatus {
  PLACED
  CONFIRMED
  PROCESSING
  PREPARED
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  COD
  CARD
  UPI
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum NotificationType {
  ORDER_STATUS
  PROMOTIONAL
  SYSTEM
}
